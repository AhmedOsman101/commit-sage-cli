name: Release

on:
  release:
    types: [published, draft]

permissions:
  contents: write

env:
  BIOME_VERSION: 2.3.11

jobs:
  build-binaries:
    name: Build Binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: "latest"

      - name: Cache Biome
        id: cache-biome
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/biome
          key: biome-${{ env.BIOME_VERSION }}-linux-x64
          restore-keys: biome-${{ env.BIOME_VERSION }}-

      - name: Install Biome
        if: steps.cache-biome.outputs.cache-hit != 'true'
        run: |
          curl -L https://github.com/biomejs/biome/releases/download/%40biomejs%2Fbiome%40${{ env.BIOME_VERSION }}/biome-linux-x64 -o biome
          chmod +x biome
          sudo mv biome /usr/local/bin/biome

      - name: Build Linux binaries
        run: |
          mkdir -p bin
          deno compile -A -o bin/commit-sage-linux-x64 --target x86_64-unknown-linux-gnu src/main.ts
          deno compile -A -o bin/commit-sage-linux-arm64 --target aarch64-unknown-linux-gnu src/main.ts

      - name: Build Windows binary
        run: deno compile -A -o bin/commit-sage-windows-x64.exe --target x86_64-pc-windows-msvc src/main.ts

      - name: Build macOS binaries
        run: |
          deno compile -A -o bin/commit-sage-macos-x64 --target x86_64-apple-darwin src/main.ts
          deno compile -A -o bin/commit-sage-macos-arm64 --target aarch64-apple-darwin src/main.ts

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/
          retention-days: 7

  build-installer:
    name: Build Installer
    needs: build-binaries
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: bin/

      - name: Install NSIS
        run: choco install nsis -y

      - name: Build Installer
        run: |
          mkdir -p release
          & "C:\Program Files (x86)\NSIS\makensis.exe" installer\windows\commit-sage.nsi

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: installer
          path: release/*.exe
          retention-days: 7

  release:
    name: Create Release
    needs: [build-binaries, build-installer]
    runs-on: ubuntu-latest
    steps:
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: binaries

      - name: Download installer
        uses: actions/download-artifact@v4
        with:
          name: installer
          path: installer

      - name: List files
        run: |
          echo "=== Binaries ==="
          ls -la binaries/
          echo "=== Installer ==="
          ls -la installer/

      - name: Create Release
        uses: softprops/action-gh-release@v2.0.0
        with:
          files: |
            binaries/commit-sage-linux-x64
            binaries/commit-sage-linux-arm64
            binaries/commit-sage-windows-x64.exe
            binaries/commit-sage-macos-x64
            binaries/commit-sage-macos-arm64
            installer/*.exe
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
