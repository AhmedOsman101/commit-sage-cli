name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  BIOME_VERSION: 2.3.11

jobs:
  build:
    name: Build and Upload Binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: "latest"

      - name: Cache Biome
        id: cache-biome
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/biome
          key: biome-${{ env.BIOME_VERSION }}-linux-x64
          restore-keys: biome-${{ env.BIOME_VERSION }}-

      - name: Install Biome
        if: steps.cache-biome.outputs.cache-hit != 'true'
        run: |
          curl -L https://github.com/biomejs/biome/releases/download/%40biomejs%2Fbiome%40${{ env.BIOME_VERSION }}/biome-linux-x64 -o biome
          chmod +x biome
          sudo mv biome /usr/local/bin/biome

      - name: Build Linux binaries
        run: |
          mkdir -p bin
          deno compile -A -o bin/commit-sage-linux-x64 --target x86_64-unknown-linux-gnu src/main.ts
          deno compile -A -o bin/commit-sage-linux-arm64 --target aarch64-unknown-linux-gnu src/main.ts

      - name: Build Windows binary
        run: deno compile -A -o bin/commit-sage-windows-x64.exe --target x86_64-pc-windows-msvc src/main.ts

      - name: Build macOS binaries
        run: |
          deno compile -A -o bin/commit-sage-macos-x64 --target x86_64-apple-darwin src/main.ts
          deno compile -A -o bin/commit-sage-macos-arm64 --target aarch64-apple-darwin src/main.ts

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bin/commit-sage-linux-x64
            bin/commit-sage-linux-arm64
            bin/commit-sage-windows-x64.exe
            bin/commit-sage-macos-x64
            bin/commit-sage-macos-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
