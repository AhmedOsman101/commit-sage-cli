name: Release

on:
  release:
    types: [published, draft]

permissions:
  contents: write

env:
  BIOME_VERSION: 2.3.11

jobs:
  build-binaries:
    name: Build Binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: "latest"

      - name: Cache Biome
        id: cache-biome
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/biome
          key: biome-${{ env.BIOME_VERSION }}-linux-x64
          restore-keys: biome-${{ env.BIOME_VERSION }}-

      - name: Install Biome
        if: steps.cache-biome.outputs.cache-hit != 'true'
        run: |
          curl -L https://github.com/biomejs/biome/releases/download/%40biomejs%2Fbiome%40${{ env.BIOME_VERSION }}/biome-linux-x64 -o biome
          chmod +x biome
          sudo mv biome /usr/local/bin/biome

      - name: Build Linux binaries
        run: |
          mkdir -p bin
          deno compile -A -o bin/commit-sage-linux-x64 --target x86_64-unknown-linux-gnu src/main.ts
          deno compile -A -o bin/commit-sage-linux-arm64 --target aarch64-unknown-linux-gnu src/main.ts

      - name: Build Windows binary
        run: deno compile -A -o bin/commit-sage-windows-x64.exe --target x86_64-pc-windows-msvc src/main.ts

      - name: Build macOS binaries
        run: |
          deno compile -A -o bin/commit-sage-macos-x64 --target x86_64-apple-darwin src/main.ts
          deno compile -A -o bin/commit-sage-macos-arm64 --target aarch64-apple-darwin src/main.ts

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/
          retention-days: 7

  build-installer:
    name: Build Installer
    needs: build-binaries
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: bin/

      - name: Install NSIS
        run: choco install nsis -y

      - name: Build Installer
        run: |
          mkdir -p release
          makensis installer\windows\commit-sage.nsi

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: installer
          path: release/*.exe
          retention-days: 7

  build-dmg:
    name: Build DMG Installer
    needs: build-binaries
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: bin/

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Build DMG
        run: |
          mkdir -p release
          chmod +x bin/commit-sage-macos-x64
          chmod +x bin/commit-sage-macos-arm64
          
          # Create DMG for Intel
          create-dmg \
            --volname "Commit Sage" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --app-drop-link 425 178 \
            "release/CommitSage-1.0.0-macos-x64.dmg" \
            /Applications \
            "bin/commit-sage-macos-x64"
          
          # Create DMG for Apple Silicon
          create-dmg \
            --volname "Commit Sage" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --app-drop-link 425 178 \
            "release/CommitSage-1.0.0-macos-arm64.dmg" \
            /Applications \
            "bin/commit-sage-macos-arm64"

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: dmg-installers
          path: release/*.dmg
          retention-days: 7

  release:
    name: Create Release
    needs: [build-binaries, build-installer, build-dmg]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release

      - name: List files
        run: ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/binaries/bin/commit-sage-linux-x64
            release/binaries/bin/commit-sage-linux-arm64
            release/binaries/bin/commit-sage-windows-x64.exe
            release/binaries/bin/commit-sage-macos-x64
            release/binaries/bin/commit-sage-macos-arm64
            release/installer/*.exe
            release/dmg-installers/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
